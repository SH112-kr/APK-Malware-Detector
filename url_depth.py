import requests
import time
import urllib
from selenium import webdriver
from bs4 import BeautifulSoup
from selenium.webdriver.chrome.options import Options
from multiprocessing import Process, Queue
from datetime import datetime




def mal_apk_download(scan_url):
    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("headless")
    chrome_options.add_argument("disable-gpu")
    chrome_options.add_argument("user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36")
    chromedriver = 'chromedriver.exe'
    prefs = {'profile.default_content_setting_values': {'cookies' : 2, 'images': 2, 'plugins' : 2, 'popups': 2, 'geolocation': 2, 'notifications' : 2, 'auto_select_certificate': 2, 'fullscreen' : 2, 'mouselock' : 2, 'mixed_script': 2, 'media_stream' : 2, 'media_stream_mic' : 2, 'media_stream_camera': 2, 'protocol_handlers' : 2, 'ppapi_broker' : 2, 'automatic_downloads': 2, 'midi_sysex' : 2, 'push_messaging' : 2, 'ssl_cert_decisions': 2, 'metro_switch_to_desktop' : 2, 'protected_media_identifier': 2, 'app_banner': 2, 'site_engagement' : 2, 'durable_storage' : 2}}   
    chrome_options.add_experimental_option('prefs', prefs)

    dan = []
    sus = []
    nor = []
    mal_app = []
    one_html_list = []
    two_html_list = []
    three_html_list = []
    four_html_list = []
    five_html_list = []
    total_list = []
    href = []
    exc = 0
    try:
        try:
            req = requests.get(scan_url)
            html = req.content
            soup = BeautifulSoup(html, 'html.parser')
            onc_data = []
            apk_data = []
            btn_data = soup.select(
                'button'
            )
            for i in btn_data:
                onc_data.append(i.get('onclick'))
            for i in onc_data:
                if not i == None:
                    if '.apk' in i:
                        apk_data.append(i)
            apk_data = str(apk_data)
            apk_strings = apk_data.split("'")
            apk_data = apk_strings[1]
            apk_full_data = scan_url + apk_data
            print("\nDownload the app:", end="")
            print(' ' + apk_full_data)
            mal_app.append(apk_full_data)
        except:
            pass

        if len(mal_app) == 0:
            driver = webdriver.Chrome(chromedriver,chrome_options=chrome_options)
            driver.get(scan_url)
            url_list = driver.find_elements_by_tag_name("a")
            sel_url = []
            href = []
            for item in url_list:
                ahref = item.get_attribute("href")
                if not ahref == None:
                    sel_url.append(ahref)
                    if not ahref in href:
                        href.append(ahref)
            for i in sel_url:
                if '.apk' in i:
                    print("\nDownload the app:", end="")
                    print(' ' + i) 
                    mal_app.append(i)
            if len(mal_app) == 0:
                for i in href:
                    if 'html' in i or '/download.php' in i:
                        if (len(total_list) != 3):
                            one_html_list.append(i)
                            total_list.append(i)
                            break
            driver.quit()
    except:
        exc = 1
        pass

    if (len(mal_app) == 0 and len(one_html_list) != 0 and exc == 0):
        for one in one_html_list:
            try:
                driver = webdriver.Chrome(chromedriver,chrome_options=chrome_options)
                driver.get(one)
                url_list = driver.find_elements_by_tag_name("a")
                sel_url_one = []
                href_two = []
                for item in url_list:
                    ahref = item.get_attribute("href")
                    if not ahref == None:
                        sel_url_one.append(ahref)
                        if not ahref in one_html_list:
                            if not ahref in href_two:
                                href_two.append(ahref)
                for i in sel_url_one:
                    if '.apk' in i:
                        print("\nDownload the app:", end="")
                        print(' ' + i) 
                        mal_app.append(i)
                for i in href_two:
                    if 'html' in i or '/download.php' in i:
                        if (len(total_list) != 3):
                            two_html_list.append(i)
                            total_list.append(i)
                            break
                driver.quit()
            except:
                pass
        #print(one_html_list)

    if (len(mal_app) == 0 and len(two_html_list) != 0 and exc == 0):
        for two in two_html_list:
            try:
                driver = webdriver.Chrome(chromedriver,chrome_options=chrome_options)
                driver.get(two)
                url_list = driver.find_elements_by_tag_name("a")
                sel_url_two = []
                href_three = []
                for item in url_list:
                    ahref = item.get_attribute("href")
                    if not ahref == None:
                        sel_url_two.append(ahref)
                        if not ahref in one_html_list:
                            if not ahref in two_html_list:
                                if not ahref in href_three:
                                    href_three.append(ahref)
                for i in sel_url_two:
                    if '.apk' in i:
                        print("\nDownload the app:", end="")
                        print(' ' + i) 
                        mal_app.append(i)
                for i in href_three:
                    if 'html' in i or '/download.php' in i:
                        if (len(total_list) != 3):
                            three_html_list.append(i)
                            total_list.append(i)
                            break
                driver.quit()
            except:
                pass

    if (len(mal_app) == 0 and len(three_html_list) != 0 and exc == 0):
        for three in three_html_list:
            try:
                driver = webdriver.Chrome(chromedriver,chrome_options=chrome_options)
                driver.get(three)
                url_list = driver.find_elements_by_tag_name("a")
                sel_url_three = []
                href_four = []
                for item in url_list:
                    ahref = item.get_attribute("href")
                    if not ahref == None:
                        sel_url_three.append(ahref)
                        if not ahref in one_html_list:
                            if not ahref in two_html_list:
                                if not ahref in three_html_list:
                                    if not ahref in href_four:
                                        href_four.append(ahref)
                for i in sel_url_three:
                    if '.apk' in i:
                        print("\nDownload the app:", end="")
                        print(' ' + i) 
                        mal_app.append(i)
                #for i in href_four:
                #    if 'html' in i:
                #        if (len(total_list) != 3):
                #            four_html_list.append(i)
                #            total_list.append(i)
                driver.quit()
            except:
                pass
        #print(three_html_list)
    apk_name = apk_data.split("/")
    today = datetime.today()
    today = str(today.year)+'-'+str(today.month)+'-'+str(today.day)
    urllib.request.urlretrieve(apk_full_data,today+'_'+apk_name[1])


mal_apk_download('http://114.44.200.24/')
